{% extends "base.html" %}

{% block title %}ç™»å½• - Firebaseç™»å½•ç³»ç»Ÿ{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="main-container p-5">
            <div class="text-center mb-4">
                <h2 class="text-primary">ğŸ” ç”¨æˆ·ç™»å½•</h2>
                <p class="text-muted">ä½¿ç”¨æ‚¨çš„Googleè´¦å·å¿«é€Ÿç™»å½•</p>
            </div>
            
            <div class="text-center">
                <button id="googleLoginBtn" class="btn btn-google btn-lg mb-3">
                    <i class="fab fa-google me-2"></i>
                    ä½¿ç”¨Googleè´¦å·ç™»å½•
                </button>
                
                <div class="text-center my-3">
                    <span class="text-muted">æˆ–è€…</span>
                </div>
                
                <!-- é‚®ç®±å¯†ç ç™»å½•è¡¨å• -->
                <form id="emailLoginForm" class="text-start">
                    <div class="mb-3">
                        <label for="email" class="form-label">é‚®ç®±åœ°å€</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password" class="form-label">å¯†ç </label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            é‚®ç®±å¯†ç ç™»å½•
                        </button>
                    </div>
                </form>
                
                <div id="loginStatus" class="mt-3" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ç™»å½•ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨éªŒè¯æ‚¨çš„èº«ä»½ï¼Œè¯·ç¨å€™...</p>
                </div>
                
                <div id="loginError" class="alert alert-danger mt-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
            
            <div class="text-center mt-4">
                <a href="{{ url_for('index') }}" class="text-muted">
                    <i class="fas fa-arrow-left me-1"></i>
                    è¿”å›é¦–é¡µ
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const emailLoginForm = document.getElementById('emailLoginForm');
    const loginStatus = document.getElementById('loginStatus');
    const loginError = document.getElementById('loginError');
    const errorMessage = document.getElementById('errorMessage');
    
    // Googleç™»å½•æä¾›å•†
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    
    // è®¾ç½®è‡ªå®šä¹‰å‚æ•°
    googleProvider.setCustomParameters({
        prompt: 'select_account'
    });
    
    // æ·»åŠ è¯­è¨€è®¾ç½®
    googleProvider.addScope('profile');
    googleProvider.addScope('email');
    
    // Googleç™»å½•
    googleLoginBtn.addEventListener('click', function() {
        // æ˜¾ç¤ºç™»å½•çŠ¶æ€
        loginStatus.style.display = 'block';
        loginError.style.display = 'none';
        googleLoginBtn.disabled = true;
        
        // æ‰§è¡ŒGoogleç™»å½• - ä½¿ç”¨å¼¹çª—æ–¹å¼ï¼ˆæ›´å¯é ï¼‰
        firebase.auth().signInWithPopup(googleProvider)
            .then(function(result) {
                console.log('Googleç™»å½•æˆåŠŸ:', result.user.email);
                
                // è·å–ID token
                return result.user.getIdToken();
            })
            .then(function(idToken) {
                console.log('è·å–åˆ°ID tokenï¼Œå‘é€åˆ°åç«¯éªŒè¯');
                
                // å‘é€tokenåˆ°åç«¯éªŒè¯
                return fetch('/verify-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        idToken: idToken
                    })
                });
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.success) {
                    console.log('åç«¯éªŒè¯æˆåŠŸ:', data.user);
                    // é‡å®šå‘åˆ°æ§åˆ¶å°
                    window.location.href = '/dashboard';
                } else {
                    throw new Error(data.error || 'éªŒè¯å¤±è´¥');
                }
            })
            .catch(function(error) {
                console.error('Googleç™»å½•é”™è¯¯:', error);
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                errorMessage.textContent = error.message || 'ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•';
                loginError.style.display = 'block';
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                googleLoginBtn.disabled = false;
            })
            .finally(function() {
                // éšè—ç™»å½•çŠ¶æ€
                loginStatus.style.display = 'none';
            });
    });
    
    // é‚®ç®±å¯†ç ç™»å½•
    emailLoginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            showError('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
            return;
        }
        
        // æ˜¾ç¤ºç™»å½•çŠ¶æ€
        showStatus();
        
        // å‘é€é‚®ç®±ç™»å½•è¯·æ±‚
        fetch('/email-login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: email,
                password: password
            })
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            if (data.success) {
                console.log('é‚®ç®±ç™»å½•æˆåŠŸ:', data.user);
                // é‡å®šå‘åˆ°æ§åˆ¶å°
                window.location.href = '/dashboard';
            } else {
                throw new Error(data.error || 'ç™»å½•å¤±è´¥');
            }
        })
        .catch(function(error) {
            console.error('é‚®ç®±ç™»å½•é”™è¯¯:', error);
            showError(error.message || 'ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
        })
        .finally(function() {
            hideStatus();
        });
    });
    
    function showStatus() {
        loginStatus.style.display = 'block';
        loginError.style.display = 'none';
        googleLoginBtn.disabled = true;
        emailLoginForm.querySelector('button[type="submit"]').disabled = true;
    }
    
    function hideStatus() {
        loginStatus.style.display = 'none';
        googleLoginBtn.disabled = false;
        emailLoginForm.querySelector('button[type="submit"]').disabled = false;
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        loginError.style.display = 'block';
    }
    
    // ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            console.log('ç”¨æˆ·å·²é€šè¿‡Firebaseè®¤è¯:', user.email);
        } else {
            console.log('ç”¨æˆ·æœªç™»å½•');
        }
    });
});
</script>
{% endblock %}
