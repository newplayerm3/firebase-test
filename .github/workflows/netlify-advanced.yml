name: Advanced Netlify Deployment

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'
  NETLIFY_TIMEOUT: '10m'

jobs:
  # ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  lint-and-test:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found, skipping install"
          fi
          
      - name: ğŸ§¹ Lint check
        run: |
          if npm run lint --if-present; then
            echo "âœ… Lint check passed"
          else
            echo "âš ï¸ No lint script found or lint failed"
          fi
          
      - name: ğŸ§ª Run tests
        run: |
          if npm test --if-present; then
            echo "âœ… Tests passed"
          else
            echo "âš ï¸ No test script found"
          fi

  # éƒ¨ç½²åˆ°Netlify
  deploy:
    name: ğŸš€ Deploy to Netlify
    runs-on: ubuntu-latest
    needs: lint-and-test  # ä¾èµ–ä»£ç æ£€æŸ¥é€šè¿‡
    if: github.ref == 'refs/heads/main'  # åªåœ¨mainåˆ†æ”¯éƒ¨ç½²
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
            echo "âœ… Dependencies installed"
          else
            echo "ğŸ“„ No package.json found - static site deployment"
          fi
          
      - name: ğŸ”¨ Build project
        run: |
          if [ -f package.json ] && npm run build --if-present; then
            echo "âœ… Build completed successfully"
            ls -la dist/ || ls -la build/ || echo "No build output directory found"
          else
            echo "ğŸ“„ No build step required for static site"
          fi
          
      - name: ğŸ” Pre-deployment checks
        run: |
          echo "ğŸ“‹ Pre-deployment validation..."
          
          # æ£€æŸ¥å¿…è¦æ–‡ä»¶
          if [ ! -f index.html ]; then
            echo "âŒ index.html not found!"
            exit 1
          fi
          
          # æ£€æŸ¥Netlifyé…ç½®
          if [ -f netlify.toml ]; then
            echo "âœ… netlify.toml found"
            cat netlify.toml
          else
            echo "âš ï¸ No netlify.toml found, using default settings"
          fi
          
          # æ£€æŸ¥é‡å®šå‘è§„åˆ™
          if [ -f _redirects ]; then
            echo "âœ… _redirects found"
            cat _redirects
          else
            echo "â„¹ï¸ No _redirects file found"
          fi
          
          echo "ğŸ“Š Deployment directory contents:"
          ls -la
          
      - name: ğŸš€ Deploy to Netlify
        uses: netlify/actions/cli@master
        with:
          args: deploy --prod --dir=. --message="ğŸš€ Auto-deploy from commit ${{ github.sha }} by ${{ github.actor }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_PROJECT_ID }}
          
      - name: ğŸ“Š Deployment summary
        if: success()
        run: |
          echo "## ğŸ‰ éƒ¨ç½²æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ éƒ¨ç½²ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤å“ˆå¸Œ**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "æ‚¨çš„ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ°Netlifyï¼" >> $GITHUB_STEP_SUMMARY
          
      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš€ Netlifyé¢„è§ˆéƒ¨ç½²

              âœ… æ‚¨çš„æ›´æ”¹å·²æˆåŠŸéƒ¨ç½²åˆ°Netlifyé¢„è§ˆç¯å¢ƒï¼

              ### ğŸ“‹ éƒ¨ç½²è¯¦æƒ…
              - **æäº¤**: \`${{ github.sha }}\`
              - **åˆ†æ”¯**: \`${{ github.head_ref }}\`
              - **éƒ¨ç½²æ—¶é—´**: ${new Date().toISOString()}

              ### ğŸ” é¢„è§ˆé“¾æ¥
              éƒ¨ç½²å®Œæˆåï¼Œæ‚¨å¯ä»¥åœ¨Netlifyä»ªè¡¨æ¿ä¸­æŸ¥çœ‹é¢„è§ˆé“¾æ¥ã€‚

              ---
              *æ­¤è¯„è®ºç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*`
            })

  # éƒ¨ç½²å¤±è´¥æ—¶çš„é€šçŸ¥
  notify-failure:
    name: ğŸ“§ Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: ğŸ“§ Send failure notification
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥é€šçŸ¥"
          echo "æäº¤: ${{ github.sha }}"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "æäº¤è€…: ${{ github.actor }}"
          echo "å¤±è´¥æ—¶é—´: $(date -u)"
